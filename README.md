# Minecraft Server Backend (работает только со стабильными версиями)

Это api предназначено для автоматического запуска и управления сервером Minecraft. На данный момент поддерживается работа только с одним сервером.
Для работы приложения требуется установленный Docker (версии 18.06.0 или выше) и Docker Compose (версии 1.27.0 или выше).

## Описание

Приложение позволяет:

- Автоматически скачивать и устанавливать необходимую версию Java для запуска сервера Minecraft.
- Управлять запуском серверов через HTTP-запросы.
- Настроить параметры сервера с помощью конфигурационного файла.

## Требования

Для работы приложения необходимо:

- Доступ к интернету для скачивания Java и серверных файлов.
- Docker (версии 18.06.0 или выше) и Docker Compose (версии 1.27.0 или выше).

## Доступные сборки

На данный момент в автосборке сервера поддерживаются версии:

- Vanilla
- Forge (mods)

## Установка

- Склонируйте репозиторий:

```bash
git clone https://github.com/your-repo/minecraft-backend.git
cd minecraft-backend
```

- Запустите проект с помощью Docker Compose

```bash
docker-compose up -d
```

## Конфигурация

Структура файла config.json:

```json
{
  "serverDirectory": "./server",
  "javaPath": "./java/jdk/bin/java",
  "javaDownloads": {
    "linux": {
      "base": "https://api.adoptium.net/v3/binary/latest/{version}/ga/linux/x64/jdk/hotspot/normal/adoptium?project=jdk"
    }
  },
  "maxMemory": "2G",
  "minMemory": "1G",
  "defaultServerType": "vanilla",
  "defaultServerVersion": "1.20.6"
}
```

Параметры конфигурации:

- serverDirectory : Путь к папке, где будут храниться файлы сервера.
- javaPath : Путь к исполняемому файлу Java. Если Java еще не установлена, приложение автоматически скачает её.
- javaDownloads : Настройки для скачивания Java. Включает базовый URL для Linux.
- maxMemory : Максимальный объем оперативной памяти, выделяемый серверу (например, 2G).
- minMemory : Минимальный объем оперативной памяти, выделяемый серверу (например, 1G).
- defaultServerType : Параметр стандартного типа сервера, если параметр не передан в запросе запуска (vanilla для стандартного сервера Minecraft).
- defaultServerVersion : Параметр стандартной версии сервера, если параметр не передан в запросе запуска (1.20.6 для стандартного сервера Minecraft).

Стуктура файла .env:

```
DATABASE_PATH=/app/data/users.db
JWT_SECRET=obyazatelno_input_your_jwt_secret_key
COMPOSE_PROFILES=frontend
```

- DATABASE_PATH отвечает за стандартный путь базы данных (для авторизации используется SQlite)
- JWT_SECRET используется для шифрования токена (авторизация фронтенда)
- COMPOSE_PROFILES является переменной, отвечающей за возможность сборки фронтенда и бекенда или просто бекенда. Если нет нужды во фронтенде, можно оставить перменную пустой:

```
COMPOSE_PROFILES=
```

В таком случае, фронтенд собираться не будет.

## Запуск приложения

Маршрут /start

Параметры запроса:
type : Тип сервера (например, vanilla для стандартного сервера Minecraft). P.S. Тип можно оставить пустым, будет выбрана версия vanilla.
version : Версия сервера Minecraft (например, 1.20.1). P.S. Версию можно не указывать, будет выбрана версия 1.20.6

**Логика работы:**

- Проверяется наличие необходимой версии Java.
- Скачивается и устанавливается Java, если она отсутствует (при первом запуске контейнера всегда происходит скачивание Java).
- Скачивается JAR-файл сервера Minecraft указанной версии.
- Сервер запускается с указанными параметрами памяти.

### Остановка сервера

Маршрут /stop

**Логика работы:**

- Функция stopMinecraftServer отправляет команду stop в консоль сервера и дожидается завершения процесса.

### Рестарт сервера

Маршрут /restart?type=vanilla&version=1.20.1"

**Логика работы:**

- Выполняется шаг "Остановка сервера".
- Выполняется шаг "Запуск сервера".
- Примечание: В текущей версии необходимо передавать параметры (type и version) при рестарте. В будущем это будет исправлено.

### Сохранение мира

Маршрут /save

**Логика работы:**

- На сервере выполнится команда "save-all", которая сохранит мир

### Получение информации о сервере

Маршрут /status

**Логика работы:**

- Выполняется функция getMemoryUsage для получения данных об использовании оперативной памяти.
- Выполняется функция getPlayerCount для получения списка игроков на сервере (пока не работает, используется заглушка).

### Отправление команд на сервер

/command \

В теле запроса прописывается команда формата:
```json
"command": "gamemode survival superassa"
```
> Поле command (обязательное): строка, содержащая команду, которую нужно выполнить на  сервере.
Пример команд: "gamemode survival superassa", "time set day", "say Hello World!".

**Логика работы:**
* Приложение проверяет, запущен ли Minecraft-сервер.
* Если сервер запущен, команда из тела запроса передается в консоль сервера.
* Если сервер не запущен, возвращается ошибка с кодом 500 и сообщением: "Сервер Minecraft не запущен.".

## Система логирования
В версии 1.4a была переработана система логирования. Теперь она более гибкая и удобная для настройки. Был добавлен отдельный модуль логирования и конфигурационный файл.

Конфигурация логирования находится в файле logger.json:
```json
{
  "logging": {
    "enabled": true,
    "debug": true,
    "java": true,
    "commandOutup": true,
    "commandError": true,
    "commandSent": true,
    "minecraftServer": true,
    "vanilla": true,
    "forge": true,
    "fabric": true
  }
}
```
### Параметры конфигурации
* enabled : Общий флаг для включения/выключения логирования.
  * Если установлен в false, все логи отключаются, независимо от настроек отдельных категорий.
  * Если установлен в true, логи работают согласно настройкам каждой категории.
* Отдельные категории (debug, java, minecraftServer, и т.д.) :
  * Каждая категория имеет булево значение (true или false).
  * Если категория включена (true), сообщения этой категории будут выводиться.
  * Если категория выключена (false), сообщения этой категории игнорируются.
Пример работы:
* Если enabled: false, то все логи отключены.
* Если enabled: true и minecraftServer: false, то логи для Minecraft Server не будут выводиться, но остальные категории (например, java) будут работать.

# Планы про проекту
- [x] Добавление Vanilla.
- [x] Добавление автовыбора Java для сервера.
- [x] Добавление сборки проекта через Docker.
- [x] Добавление Forge.
- [x] Добавление системы настройки логирования.
- [x] Добавление аутентификации к маршрутам.
- [x] Добавление маршрута для отправки команд серверу
- [ ] Добавление Fabric.
- [ ] Добавление Paper, Spigot.
- [ ] Добавление снапшот и не стабильных версий (a, b и более старых, по возможности).
- [ ] Добавление Purpur, Folia.
- [ ] Добавление Quilt.
- [x] Добавление Frontend для управления сервером (React).
- [ ] Добавление расшириненного функционала для Frontend.

# История версий
- 0.1: Добавление api для работы сервера
- 0.2: Добавлена возможность автоматического скачивания java и сервера выбранной версии
- 1.0: Переделана структура проекта, а также добавлена сборка через Docker. Добавлена двех новых команды: restart (просто вызывается stop и start) и save (выполняет запрос на сохранение мира)
- 1.1: Удалена папка "Java", в которой хранились версии Java (теперь при пересборке контейнер и запуске сервера, всегда выполняется первое скачивание Java)
- 1.2: Добавлена аутентификация к основным маршрутам (если присутствует .env файл и в нём указан пароль)
- 1.2a: Модифицирована логика выбора версии Java
- 1.3: Добавлен новый маршрут для оправления команд на сервер через тело (body) запроса (Нужно поправить количество игроков на сервере, чтобы бралось актуальное кол-во)
- 1.4: Добавление Forge версии для запуска
- 1.4а: Переработана система логирования: добавлена возможность выбирать, какую информацию выводить
- 1.4b: Поправлен вывод количества игроков на сервер
- 1.4c: Release. Модифицирован маршруты start и stop, исправлен маршрут restart.
- 1.5: Первичное добавление фронтенда
- 1.5a: Добавление websocket
- 1.5b: Добавлени функционала фронтенда
- 1.5с: Добавление авторизации и регистрации на фронтенде
- 1.5d: Добавлена автосборка фронтенда
- 1.5e: Удален доступ по API_PASSWORD
