# MCStack (работает только со стабильными версиями)
Расширенная информация содержится тут: https://outline.nikitaredk0.ru/s/9d2d3ed1-7ddd-485f-acf1-81a405415224/doc/minecraft-server-Vx0adnYoK3

## **Описание**

Приложение позволяет:

* Автоматически скачивать и устанавливать необходимую версию Java для запуска сервера Minecraft.
* Управлять запуском серверов через HTTP-запросы.
* Настроить параметры сервера с помощью конфигурационного файла.

## **Требования**

Для работы приложения необходимо:

* Доступ к интернету для скачивания Java и серверных файлов.
* Docker (версии 18.06.0 или выше) и Docker Compose (версии 1.27.0 или выше). Если Docker не установлен, то можно запустить скрипт start и установить Docker через него.

## **Доступные сборки**

На данный момент в автосборке сервера поддерживаются версии:

* ***Vanilla***
* ***Mods***:
  * *Forge*
  * *Fabric*
* ***Plugins***:
  * *Paper*

## **Установка**

* Склонируйте репозиторий:

```javascript
git clone https://github.com/crazykivi/minecraft-backend.git
cd minecraft-backend
```
* Или скачайте один из архивов, доступных в релизных версия: [github.com/releases](https://github.com/crazykivi/MCStack/releases)

* Запустите скрипт start.bat (для Windows) или start.sh (для Ubuntu и Debian)
> Для Linux (Ubuntu или Debian) нужно сделать файл исполняемым: 
> ```bash
> chmod +x start.sh
> ```
> После чего запустите скрипт ./start.sh
* Или запустите проект вручную с помощью Docker Compose

```javascript
docker compose up -d
```

## **Конфигурация**

### Краткая инструкция по настройке ```.env``` файла
```
# Путь к базе данных SQLite
DATABASE_PATH=/app/data/users.db

# Секретный ключ для JWT
JWT_SECRET=obyazatelno_input_your_jwt_secret_key

# Настройки Redis (если используется внешний)
# REDIS_HOST=redis
# REDIS_PORT=6379

# Если планируется ручноый запуск, без использования скриптов, то можно прописать профили в файле
# Профили запуска:
COMPOSE_PROFILES=all  # Запуск всего (фронтенд + бекенд + redis)
# Альтернативы:
# COMPOSE_PROFILES=local-redis   # Без фронтенда, с Redis
# COMPOSE_PROFILES=frontend      # Без Redis, с фронтендом
# Убрать переменную COMPOSE_PROFILES — запустится только API

# URL бекенда для фронтенда
# Если не задано, используется http://localhost:3001
REACT_APP_API_URL=http://localhost:3001
```

Параметры конфигурации:

* `DATABASE_PATH` отвечает за стандартный путь базы данных (для авторизации используется **SQlite**)
* `JWT_SECRET` используется для шифрования токена (авторизация фронтенда)
* `COMPOSE_PROFILES` является переменной, отвечающей за возможность сборки **Frontend** и **Backend** или просто **Backend**. Если нет нужды во **Frontend**, можно оставить перменную пустой:

> ```bash
> COMPOSE_PROFILES=
> ```
>В таком случае, **Frontend** и **Redis** собираться не будет

* Если нет нужды в **Redis** (уже есть настроенный), то конфиг к нему также нужно прописать в переменных, а также нужно выбрать профиль `COMPOSE_PROFILES=frontend` или `COMPOSE_PROFILES=` (если не требуется **Frontend**):

```docker
REDIS_HOST=redis
REDIS_PORT=6379
```

Файл ```.env``` уже создан в корне проекта, для локальной работы можно ничего не менять.

### Краткая инструкция по настройке ```config.json``` файла
```javascript
{
  "serverDirectory": "./server",
  "javaPath": "./java/jdk/bin/java",
  "javaDownloads": {
    "linux": {
      "base": "https://api.adoptium.net/v3/binary/latest/{version}/ga/linux/x64/jdk/hotspot/normal/adoptium?project=jdk"
    }
  },
  "maxMemory": "2G",
  "minMemory": "1G",
  "defaultServerType": "vanilla",
  "defaultServerVersion": "1.21.5",
  "disableFrontendAuth": false
}
```

Параметры конфигурации:

* `serverDirectory`: Путь к папке, где будут храниться файлы сервера.
* `javaPath`: Путь к исполняемому файлу Java. Если Java еще не установлена, приложение автоматически скачает её.
* `javaDownloads`: Настройки для скачивания Java. Включает базовый URL для Linux.
* `maxMemory`: Максимальный объем оперативной памяти, выделяемый серверу (например, 2G).
* `minMemory`: Минимальный объем оперативной памяти, выделяемый серверу (например, 1G).
* `defaultServerType`: Параметр стандартного типа сервера, если параметр не передан в запросе запуска (vanilla для стандартного сервера Minecraft).
* `defaultServerVersion`: Параметр стандартной версии сервера, если параметр не передан в запросе запуска (1.21.5 для стандартного сервера Minecraft).
* `disableFrontendAuth`: Параметр для отключения и включения авторизации для Frontend и Backend
  * По умолчанию  — авторизация включена: `false`
  * Проверки авторизации отключаются как на Backend, так и на Frontend: `true`

### Краткая инструкция по настройке ```logger.json``` файла

```json
{
  "logging": {
    "enabled": true,
    "debug": false,
    "java": true,
    "commandOutup": true,
    "commandError": true,
    "commandSent": true,
    "minecraftServer": true,
    "vanilla": true,
    "forge": true,
    "fabric": true,
    "paper": true,
    "spigot": true,
    "webSocket": false,
    "configLog": false,
    "redis": true
  }
}
```

Параметры конфигурации:

* `enabled`: Глобальный переключатель логирования.
  * `true` — все логирование включено / `false`— всё логирование отключается.
* `debug`: Уровень детализации логов:
  * `true` — выводятся подробные дебаг-сообщения / `false` — выключить вывод дебаг сообщений.
* `java`: Логирование событий, связанных с запуском и работой Java:
  * `true` — включить вывод логов Java / `false` — выключить вывод логов Java .
* `commandOutput`: Вывод стандартных сообщений команд (`stdout`).
  * `true` — включить вывод команд / `false` — отключить вывод команд.
* `commandError`: Логирование ошибок выполнения команд (`stderr`).
  * `true` — выводить ошибки команд / `false` — не выводить ошибки команд.
* `commandSent`: Логирование отправленных команд на сервер.
  * `true` — выводить каждую отправленную команду / `false` — не выводить каждую отправленную команду.
* `minecraftServer`: Общее логирование событий сервера Minecraft.
  * `true` — включить логи сервера / `false` — отключить логи сервера.
* `vanilla`: Логирование событий для сервера типа `Vanilla` .
  * `true` — включено / `false` — выключено.
* `forge`: Логирование событий для сервера типа `Forge` .
  * `true` — включено / `false` — выключено.
* `fabric`: Логирование событий для сервера типа `Fabric` .
  * `true` — включено / `false` — выключено.
* `paper`: Логирование событий для сервера типа `Paper` .
  * `true` — включено / `false` — выключено.
* `spigot`: Логирование событий для сервера типа `Spigot` .
  * `true` — включено / `false` — выключено.
* `webSocket`: Логирование событий WebSocket-соединения (например, обмен данными между клиентом и сервером).
  * `true` — включено / `false` — выключено.
* `configLog`: Логирование изменений конфигурационных файлов.
  * `true` — записывать изменения в конфигах / `false` — не записывать.
* `redis`: Логирование взаимодействия с `Redis` (кэширование, чтение/запись данных).
  * `true` — включено / `false` — выключено.

## **Запуск приложения**

Маршрут /start

Параметры запроса: type : Тип сервера (например, vanilla для стандартного сервера Minecraft). P.S. Тип можно оставить пустым, будет выбрана версия vanilla. version : Версия сервера Minecraft (например, 1.20.1). P.S. Версию можно не указывать, будет выбрана версия 1.21.5

**Логика работы:**

* Проверяется наличие необходимой версии Java.
* Скачивается и устанавливается Java, если она отсутствует (при первом запуске контейнера всегда происходит скачивание Java).
* Скачивается JAR-файл сервера Minecraft указанной версии.
* Сервер запускается с указанными параметрами памяти.

### **Остановка сервера**

Маршрут /stop

**Логика работы:**

* Функция stopMinecraftServer отправляет команду stop в консоль сервера и дожидается завершения процесса.

### **Рестарт сервера**

Маршрут /restart?type=vanilla&version=1.21.5"

**Логика работы:**

* Выполняется шаг "Остановка сервера".
* Выполняется шаг "Запуск сервера".
* Примечание: В текущей версии необходимо передавать параметры (type и version) при рестарте. В будущем это будет исправлено.

### **Сохранение мира**

Маршрут /save

**Логика работы:**

* На сервере выполнится команда "save-all", которая сохранит мир

### **Получение информации о сервере**

Маршрут /status

**Логика работы:**

* Выполняется функция getMemoryUsage для получения данных об использовании оперативной памяти.
* Выполняется функция getPlayerCount для получения списка игроков на сервере (пока не работает, используется заглушка).

### **Отправление команд на сервер**

/command \\

В теле запроса прописывается команда формата:

```javascript
"command": "gamemode survival superassa"
```

> Поле command (обязательное): строка, содержащая команду, которую нужно выполнить на сервере. Пример команд: "gamemode survival superassa", "time set day", "say Hello World!".

**Логика работы:**

* Приложение проверяет, запущен ли Minecraft-сервер.
* Если сервер запущен, команда из тела запроса передается в консоль сервера.
* Если сервер не запущен, возвращается ошибка с кодом 500 и сообщением: "Сервер Minecraft не запущен.".
