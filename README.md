# Minecraft Server Backend (работает только со стабильными версиями)
Это api предназначено для автоматического запуска и управления сервером Minecraft. На данный момент поддерживается работа только с одним сервером.
Для работы приложения требуется установленный Docker (версии 18.06.0 или выше) и Docker Compose (версии 1.27.0 или выше).

## Описание
Приложение позволяет:
* Автоматически скачивать и устанавливать необходимую версию Java для запуска сервера Minecraft.
* Управлять запуском серверов через HTTP-запросы.
* Настроить параметры сервера с помощью конфигурационного файла.
## Требования
Для работы приложения необходимо:
* Доступ к интернету для скачивания Java и серверных файлов.
* Docker (версии 18.06.0 или выше) и Docker Compose (версии 1.27.0 или выше).
## Доступные сборки
На данный момент в автосборке сервера работает только версии Vanilla и Forge (mods).
## Установка
* Склонируйте репозиторий:
```
git clone https://github.com/your-repo/minecraft-backend.git
cd minecraft-backend
```
* Установите зависимости:
```
npm install
```
* По желанию: настройте конфигурационный файл config.json в папке проекта "config" или .env, находящийся в корке проекта (см. раздел "Конфигурация").
* Запустите приложение:
```
node index.js
```
## Конфигурация
Структура файла config.json:
```
{
  "serverDirectory": "./server",
  "javaPath": "./java/jdk/bin/java",
  "javaDownloads": {
    "linux": {
      "base": "https://api.adoptium.net/v3/binary/latest/{version}/ga/linux/x64/jdk/hotspot/normal/adoptium?project=jdk"
      }
    },
  "maxMemory": "2G",
  "minMemory": "1G",
  "defaultServerType": "vanilla",
  "defaultServerVersion": "1.20.6"
}
```
Параметры конфигурации:
* serverDirectory : Путь к папке, где будут храниться файлы сервера.
* javaPath : Путь к исполняемому файлу Java. Если Java еще не установлена, приложение автоматически скачает её.
* javaDownloads : Настройки для скачивания Java. Включает базовый URL для Linux.
* maxMemory : Максимальный объем оперативной памяти, выделяемый серверу (например, 2G).
* minMemory : Минимальный объем оперативной памяти, выделяемый серверу (например, 1G).
* defaultServerType : Параметр стандартного типа сервера, если параметр не передан в запросе запуска (vanilla для стандартного сервера Minecraft).
* defaultServerVersion : Параметр стандартной версии сервера, если параметр не передан в запросе запуска (1.20.6 для стандартного сервера Minecraft).

Стуктура файла .env:
```
API_PASSWORD=your_secure_password_here
```
Файл .env используется для настройки пароля доступа к API. Аутентификация выполняется посредством передачи параметра Authorization в заголовке.
Пример запроса:
```
curl -H "Authorization: your_secure_password_here" http://192.168.20.184:3001/start?type=vanilla&version=1.10.1
```
## Запуск сервера
Для запуска сервера отправьте HTTP-запрос на следующий URL:
```
http://192.168.20.184:3001/start?type=vanilla&version=1.20.1
```
Параметры запроса:
type : Тип сервера (например, vanilla для стандартного сервера Minecraft). P.S. Тип можно оставить пустым, будет выбрана версия vanilla.
version : Версия сервера Minecraft (например, 1.20.1). P.S. Версию можно не указывать, будет выбрана версия 1.20.6
## Пример использования
### Запуск сервера
Пример запроса (GET):
```
curl "http://192.168.20.184:3001/start?type=vanilla&version=1.20.1"
```
*** Логика работы: ***
* Проверяется наличие необходимой версии Java.
* Скачивается и устанавливается Java, если она отсутствует (при первом запуске контейнера всегда происходит скачивание Java).
* Скачивается JAR-файл сервера Minecraft указанной версии.
* Сервер запускается с указанными параметрами памяти.
### Остановка сервера
Пример запроса (GET):
```
curl "http://192.168.20.184:3001/stop"
```
*** Логика работы: ***
* Функция stopMinecraftServer отправляет команду stop в консоль сервера и дожидается завершения процесса.

### Рестарт сервера
Пример запроса (GET):
```
curl "http://192.168.20.184:3001/restart?type=vanilla&version=1.20.1"
```
*** Логика работы: ***
* Выполняется шаг "Остановка сервера".
* Выполняется шаг "Запуск сервера".
* Примечание: В текущей версии необходимо передавать параметры (type и version) при рестарте. В будущем это будет исправлено. 

### Сохранение мира
Пример запроса:
```
curl "http://192.168.20.184:3001/start?type=vanilla&version=1.20.1"
```
*** Логика работы: ***
* На сервере выполнится команда "save-all", которая сохранит мир

### Получение информации о сервере
Пример запроса (GET):
```
curl "http://192.168.20.184:3001/status"
```
*** Логика работы: ***
* Выполняется функция getMemoryUsage для получения данных об использовании оперативной памяти.
* Выполняется функция getPlayerCount для получения списка игроков на сервере (пока не работает, используется заглушка).

### Отправление команд на сервер
Добавил возможность отправить любую команду на маршрут /command
Пример запроса (POST):
```
curl -X POST http://192.168.20.184:3001/command \
  -H "Content-Type: application/json" \
  -d '{"command": "gamemode survival superassa"}'
```
!Поле command (обязательное): строка, содержащая команду, которую нужно выполнить на сервере.!
Пример: "gamemode survival superassa", "time set day", "say Hello World!".

*** Логика работы: ***
* Приложение проверяет, запущен ли Minecraft-сервер.
* Если сервер запущен, команда из тела запроса передается в консоль сервера.
* Если сервер не запущен, возвращается ошибка с кодом 500 и сообщением: "Сервер Minecraft не запущен.".

## Система логирования
В версии 1.4a была переработана система логирования. Теперь она более гибкая и удобная для настройки. Был добавлен отдельный модуль логирования и конфигурационный файл.

Конфигурация логирования находится в файле logger.json:
```
{
    "logging": {
      "enabled": true,
      "debug": true,
      "java": true,
      "commandOutup": true,
      "commandError": true,
      "commandSent": true,
      "minecraftServer": true,
      "vanilla": true,
      "forge": true,
      "fabric": true
  }
}
```
### Параметры конфигурации
* enabled : Общий флаг для включения/выключения логирования.
  * Если установлен в false, все логи отключаются, независимо от настроек отдельных категорий.
  * Если установлен в true, логи работают согласно настройкам каждой категории.
* Отдельные категории (debug, java, minecraftServer, и т.д.) :
  * Каждая категория имеет булево значение (true или false).
  * Если категория включена (true), сообщения этой категории будут выводиться.
  * Если категория выключена (false), сообщения этой категории игнорируются.
Пример работы:
* Если enabled: false, то все логи отключены.
* Если enabled: true и minecraftServer: false, то логи для Minecraft Server не будут выводиться, но остальные категории (например, java) будут работать.

# Дальнейшие планы
* Расширить поддержку типов серверов (добавить к mods fabric версию, а в plugin paper).

# История версий:
- 0.1: Добавление api для работы сервера
- 0.2: Добавлена возможность автоматического скачивания java и сервера выбранной версии
- 1.0: Переделана структура проекта, а также добавлена сборка через Docker. Добавлена двех новых команды: restart (просто вызывается stop и start) и save (выполняет запрос на сохранение мира)
- 1.1: Удалена папка "Java", в которой хранились версии Java (теперь при пересборке контейнер и запуске сервера, всегда выполняется первое скачивание Java)
- 1.2: Добавлена аутентификация к основным маршрутам (если присутствует .env файл и в нём указан пароль)
- 1.2a: Модифицирована логика выбора версии Java
- 1.3: Добавлен новый маршрут для оправления команд на сервер через тело (body) запроса (Нужно поправить количество игроков на сервере, чтобы бралось актуальное кол-во)
- 1.4: Добавление Forge версии для запуска
- 1.4а: Переработана система логирования: добавлена возможность выбирать, какую информацию выводить
- 1.4b: Поправлен вывод количества игроков на сервер
- 1.4c: Модифицирован маршруты start и stop, исправлен маршрут restart. 